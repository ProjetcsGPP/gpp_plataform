"""\nTestes de API Views - Módulo de Ações - Ações PNGI\n\nTesta ViewSets de:\n- TipoEntraveAlerta (configuração)\n- Acoes (entidade principal)\n- AcaoPrazo (prazos das ações)\n- AcaoDestaque (destaques das ações)\n\nCobre as 4 roles hierárquicas com validações específicas:\n- COORDENADOR_PNGI: Acesso total\n- GESTOR_PNGI: Acesso total\n- OPERADOR_ACAO: Gerencia ações (MAS bloqueado em TipoEntraveAlerta)\n- CONSULTOR_PNGI: Apenas leitura\n"""\n\nfrom django.test import TestCase\nfrom .base import BaseTestCase, BaseAPITestCase\nfrom django.contrib.auth import get_user_model\nfrom rest_framework.test import APIClient\nfrom rest_framework import status\nfrom datetime import date, timedelta\nfrom django.utils import timezone\n\nfrom accounts.models import Aplicacao, Role, UserRole\nfrom ..models import (\n    Eixo, SituacaoAcao, VigenciaPNGI, TipoEntraveAlerta,\n    Acoes, AcaoPrazo, AcaoDestaque\n)\n\nUser = get_user_model()\n\nclass BaseAPITestCase(BaseTestCase):\n    \"\"\"Classe base reutilizável para testes de API\"\"\"\n    \n    databases = {'default', 'gpp_plataform_db'}\n    \n    def setUp(self):\n        \"\"\"Setup inicial com aplicação, roles e usuários\"\"\"\n        self.client = APIClient()\n        \n        # Criar aplicação usando get_or_create para evitar IntegrityError\n        self.app, _ = Aplicacao.objects.get_or_create(\n            codigointerno='ACOES_PNGI',\n            defaults={'nomeaplicacao': 'Ações PNGI'}\n        )\n        \n        # Criar as 4 roles usando get_or_create\n        self.role_coordenador, _ = Role.objects.get_or_create(\n            aplicacao=self.app,\n            codigoperfil='COORDENADOR_PNGI',\n            defaults={'nomeperfil': 'Coordenador - Gerencia Configurações'}\n        )\n        \n        self.role_gestor, _ = Role.objects.get_or_create(\n            aplicacao=self.app,\n            codigoperfil='GESTOR_PNGI',\n            defaults={'nomeperfil': 'Gestor Acoes PNGI'}\n        )\n        \n        self.role_operador, _ = Role.objects.get_or_create(\n            aplicacao=self.app,\n            codigoperfil='OPERADOR_ACAO',\n            defaults={'nomeperfil': 'Operador - Apenas Ações'}\n        )\n        \n        self.role_consultor, _ = Role.objects.get_or_create(\n            aplicacao=self.app,\n            codigoperfil='CONSULTOR_PNGI',\n            defaults={'nomeperfil': 'Consultor - Apenas Leitura'}\n        )\n        \n        # Criar usuários\n        self.users = {}\n        for role_name, role_obj in [\n            ('coordenador', self.role_coordenador),\n            ('gestor', self.role_gestor),\n            ('operador', self.role_operador),\n            ('consultor', self.role_consultor)\n        ]:\n            user = User.objects.create_user(\n                email=f'{role_name}@seger.es.gov.br',\n                name=f'User {role_name.title()}',\n                password='testpass123'\n            )\n            UserRole.objects.create(\n                user=user,\n                aplicacao=self.app,\n                role=role_obj\n            )\n            self.users[role_name] = user\n        \n        # Criar dados de teste base\n        self.setup_test_data()\n    \n    def setup_test_data(self):\n        \"\"\"Criar dados base compartilhados por todos os testes\"\"\"\n        # Criar Eixo (se não existe)\n        if not hasattr(self, 'eixo') or self.eixo is None:\n            self.eixo, _ = Eixo.objects.get_or_create(\n                stralias='E1',\n                defaults={'strdescricaoeixo': 'Eixo 1 - Gestão'}\n            )\n\n        # Criar SituacaoAcao (se não existe)\n        if not hasattr(self, 'situacao') or self.situacao is None:\n            self.situacao, _ = SituacaoAcao.objects.get_or_create(\n                strdescricaosituacao='Em Andamento'\n            )\n    \n    def authenticate_as(self, role_name):\n        \"\"\"Autentica como usuário específico\"\"\"\n        user = self.users[role_name]\n        self.client.force_authenticate(user=user)\n        return user\n\n# ============================================================================\n# TESTES DE TIPO ENTRAVE/ALERTA - ViewSet: TipoEntraveAlertaViewSet\n# ============================================================================\n\nclass TipoEntraveAlertaAPITests(BaseAPITestCase):\n    \"\"\"\n    Testes de API para TipoEntraveAlerta.\n    \n    TipoEntraveAlerta é CONFIGURAÇÃO, então:\n    - COORDENADOR e GESTOR: acesso total\n    - OPERADOR: BLOQUEADO (não gerencia configurações)\n    - CONSULTOR: apenas leitura\n    \n    Endpoints testados:\n    - GET    /api/v1/acoes_pngi/tipos-entrave-alerta/\n    - POST   /api/v1/acoes_pngi/tipos-entrave-alerta/\n    - GET    /api/v1/acoes_pngi/tipos-entrave-alerta/{id}/\n    - PATCH  /api/v1/acoes_pngi/tipos-entrave-alerta/{id}/\n    - DELETE /api/v1/acoes_pngi/tipos-entrave-alerta/{id}/\n    \"\"\"\n    \n    def setup_test_data(self):\n        \"\"\"Cria tipo de entrave/alerta de teste\"\"\"\n        # Chamar setup da classe base para criar Eixo e SituacaoAcao\n        super().setup_test_data()\n        \n        # Criar tipo de entrave/alerta\n        self.tipo_entrave = TipoEntraveAlerta.objects.create(\n            strdescricaotipoentravealerta='Alerta de Teste'\n        )\n    \n    # ------------------------------------------------------------------------\n    # COORDENADOR_PNGI - Acesso Total\n    # ------------------------------------------------------------------------\n    \n    def test_coordenador_can_list_tipos_entrave(self):\n        \"\"\"COORDENADOR_PNGI pode listar tipos de entrave\"\"\"\n        self.authenticate_as('coordenador')\n        response = self.client.get('/api/v1/acoes_pngi/tipos-entrave-alerta/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_coordenador_can_create_tipo_entrave(self):\n        \"\"\"COORDENADOR_PNGI pode criar tipo de entrave\"\"\"\n        self.authenticate_as('coordenador')\n        data = {'strdescricaotipoentravealerta': 'Novo Alerta Coordenador'}\n        response = self.client.post(\n            '/api/v1/acoes_pngi/tipos-entrave-alerta/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    def test_coordenador_can_update_tipo_entrave(self):\n        \"\"\"COORDENADOR_PNGI pode atualizar tipo de entrave\"\"\"\n        self.authenticate_as('coordenador')\n        data = {'strdescricaotipoentravealerta': 'Alerta Atualizado'}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/tipos-entrave-alerta/{self.tipo_entrave.idtipoentravealerta}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_coordenador_can_delete_tipo_entrave(self):\n        \"\"\"COORDENADOR_PNGI pode deletar tipo de entrave\"\"\"\n        tipo_temp = TipoEntraveAlerta.objects.create(\n            strdescricaotipoentravealerta='Para Deletar'\n        )\n        \n        self.authenticate_as('coordenador')\n        response = self.client.delete(\n            f'/api/v1/acoes_pngi/tipos-entrave-alerta/{tipo_temp.idtipoentravealerta}/'\n        )\n        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)\n    \n    # ------------------------------------------------------------------------\n    # GESTOR_PNGI - Acesso Total\n    # ------------------------------------------------------------------------\n    \n    def test_gestor_can_manage_tipos_entrave(self):\n        \"\"\"GESTOR_PNGI tem acesso completo a tipos de entrave\"\"\"\n        self.authenticate_as('gestor')\n        \n        # LIST\n        response = self.client.get('/api/v1/acoes_pngi/tipos-entrave-alerta/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        \n        # CREATE\n        data = {'strdescricaotipoentravealerta': 'Alerta Gestor'}\n        response = self.client.post(\n            '/api/v1/acoes_pngi/tipos-entrave-alerta/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    # ------------------------------------------------------------------------\n    # OPERADOR_ACAO - Bloqueado em Configurações\n    # ------------------------------------------------------------------------\n    \n    def test_operador_cannot_create_tipo_entrave(self):\n        \"\"\"OPERADOR_ACAO NÃO pode criar tipo de entrave (configuração)\"\"\"\n        self.authenticate_as('operador')\n        data = {'strdescricaotipoentravealerta': 'Tentativa Operador'}\n        response = self.client.post(\n            '/api/v1/acoes_pngi/tipos-entrave-alerta/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    def test_operador_cannot_update_tipo_entrave(self):\n        \"\"\"OPERADOR_ACAO NÃO pode atualizar tipo de entrave\"\"\"\n        self.authenticate_as('operador')\n        data = {'strdescricaotipoentravealerta': 'Update Operador'}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/tipos-entrave-alerta/{self.tipo_entrave.idtipoentravealerta}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    def test_operador_cannot_delete_tipo_entrave(self):\n        \"\"\"OPERADOR_ACAO NÃO pode deletar tipo de entrave\"\"\"\n        self.authenticate_as('operador')\n        response = self.client.delete(\n            f'/api/v1/acoes_pngi/tipos-entrave-alerta/{self.tipo_entrave.idtipoentravealerta}/'\n        )\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    # ------------------------------------------------------------------------\n    # CONSULTOR_PNGI - Apenas Leitura\n    # ------------------------------------------------------------------------\n    \n    def test_consultor_can_list_tipos_entrave(self):\n        \"\"\"CONSULTOR_PNGI pode listar tipos de entrave\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/tipos-entrave-alerta/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_consultor_cannot_create_tipo_entrave(self):\n        \"\"\"CONSULTOR_PNGI NÃO pode criar tipo de entrave\"\"\"\n        self.authenticate_as('consultor')\n        data = {'strdescricaotipoentravealerta': 'Tentativa Consultor'}\n        response = self.client.post(\n            '/api/v1/acoes_pngi/tipos-entrave-alerta/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n\n# ============================================================================\n# TESTES DE AÇÕES - ViewSet: AcoesViewSet\n# ============================================================================\n\nclass AcoesAPITests(BaseAPITestCase):\n    \"\"\"\n    Testes de API para Acoes (entidade principal).\n    \n    Ações NÃO são configuração, então:\n    - COORDENADOR, GESTOR e OPERADOR: acesso total\n    - CONSULTOR: apenas leitura\n    \n    Testa relacionamentos:\n    - idvigenciapngi (ForeignKey) - OBRIGATÓRIO\n    - idtipoentravealerta (ForeignKey) - OPCIONAL\n    - ideixo (ForeignKey) - OPCIONAL\n    - idsituacaoacao (ForeignKey) - OPCIONAL\n    \n    Endpoints testados:\n    - GET    /api/v1/acoes_pngi/acoes/\n    - POST   /api/v1/acoes_pngi/acoes/\n    - GET    /api/v1/acoes_pngi/acoes/{id}/\n    - PATCH  /api/v1/acoes_pngi/acoes/{id}/\n    - DELETE /api/v1/acoes_pngi/acoes/{id}/\n    \"\"\"\n    \n    def setup_test_data(self):\n        \"\"\"Cria dados COMPLETOS necessários para ações - simula ambiente real\"\"\"\n        # Chamar setup da classe base para criar Eixo e SituacaoAcao\n        super().setup_test_data()\n        \n        # Criar Vigência (OBRIGATÓRIO para Acao)\n        self.vigencia, _ = VigenciaPNGI.objects.get_or_create(\n            strdescricaovigenciapngi='PNGI 2026',\n            defaults={\n                'datiniciovigencia': date(2026, 1, 1),\n                'datfinalvigencia': date(2026, 12, 31)\n            }\n        )\n        \n        # Criar Tipo Entrave (OPCIONAL)\n        self.tipo_entrave = TipoEntraveAlerta.objects.create(\n            strdescricaotipoentravealerta='Alerta Teste'\n        )\n        \n        # Criar Ação COMPLETA com TODOS relacionamentos\n        self.acao = Acoes.objects.create(\n            strapelido='ACAO-001',\n            strdescricaoacao='Ação de Teste',\n            strdescricaoentrega='Entrega de Teste',\n            idvigenciapngi=self.vigencia,\n            ideixo=self.eixo,\n            idsituacaoacao=self.situacao,\n            idtipoentravealerta=self.tipo_entrave,\n            datdataentrega=date(2026, 6, 30)\n        )\n    \n    # ------------------------------------------------------------------------\n    # COORDENADOR_PNGI - Acesso Total\n    # ------------------------------------------------------------------------\n    \n    def test_coordenador_can_list_acoes(self):\n        \"\"\"COORDENADOR_PNGI pode listar ações\"\"\"\n        self.authenticate_as('coordenador')\n        response = self.client.get('/api/v1/acoes_pngi/acoes/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        # ✅ Verifica que retorna dados (não vazio)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_coordenador_can_create_acao(self):\n        \"\"\"COORDENADOR_PNGI pode criar ação\"\"\"\n        self.authenticate_as('coordenador')\n        data = {\n            'strapelido': 'ACAO-COORD-001',\n            'strdescricaoacao': 'Nova Ação do Coordenador',\n            'strdescricaoentrega': 'Entrega Coordenador',\n            'idvigenciapngi': self.vigencia.idvigenciapngi,\n            'ideixo': self.eixo.ideixo,\n            'idsituacaoacao': self.situacao.idsituacaoacao,\n            'idtipoentravealerta': self.tipo_entrave.idtipoentravealerta,\n            'datdataentrega': '2026-08-30'\n        }\n        response = self.client.post('/api/v1/acoes_pngi/acoes/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n        self.assertEqual(response.data['strapelido'], 'ACAO-COORD-001')\n    \n    def test_coordenador_can_update_acao(self):\n        \"\"\"COORDENADOR_PNGI pode atualizar ação\"\"\"\n        self.authenticate_as('coordenador')\n        data = {'strdescricaoacao': 'Ação Atualizada pelo Coordenador'}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/acoes/{self.acao.idacao}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_coordenador_can_delete_acao(self):\n        \"\"\"COORDENADOR_PNGI pode deletar ação\"\"\"\n        acao_temp = Acoes.objects.create(\n            strapelido='ACAO-TEMP',\n            strdescricaoacao='Temporária',\n            strdescricaoentrega='Entrega Temp',\n            idvigenciapngi=self.vigencia,  # OBRIGATÓRIO\n            ideixo=self.eixo,              # Adicionar para consistência\n            idsituacaoacao=self.situacao\n        )\n        \n        self.authenticate_as('coordenador')\n        response = self.client.delete(f'/api/v1/acoes_pngi/acoes/{acao_temp.idacao}/')\n        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)\n    \n    # ------------------------------------------------------------------------\n    # GESTOR_PNGI - Acesso Total\n    # ------------------------------------------------------------------------\n    \n    def test_gestor_can_manage_acoes(self):\n        \"\"\"GESTOR_PNGI tem acesso completo a ações\"\"\"\n        self.authenticate_as('gestor')\n        \n        # LIST\n        response = self.client.get('/api/v1/acoes_pngi/acoes/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n        \n        # CREATE\n        data = {\n            'strapelido': 'ACAO-GEST-001',\n            'strdescricaoacao': 'Ação do Gestor',\n            'strdescricaoentrega': 'Entrega Gestor',\n            'idvigenciapngi': self.vigencia.idvigenciapngi,\n            'ideixo': self.eixo.ideixo,\n            'idsituacaoacao': self.situacao.idsituacaoacao\n        }\n        response = self.client.post('/api/v1/acoes_pngi/acoes/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    # ------------------------------------------------------------------------\n    # OPERADOR_ACAO - Pode Gerenciar Ações\n    # ------------------------------------------------------------------------\n    \n    def test_operador_can_list_acoes(self):\n        \"\"\"OPERADOR_ACAO pode listar ações\"\"\"\n        self.authenticate_as('operador')\n        response = self.client.get('/api/v1/acoes_pngi/acoes/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_operador_can_create_acao(self):\n        \"\"\"OPERADOR_ACAO PODE criar ação (não é configuração)\"\"\"\n        self.authenticate_as('operador')\n        data = {\n            'strapelido': 'ACAO-OPER-001',\n            'strdescricaoacao': 'Ação do Operador',\n            'strdescricaoentrega': 'Entrega Operador',\n            'idvigenciapngi': self.vigencia.idvigenciapngi,\n            'ideixo': self.eixo.ideixo,\n            'idsituacaoacao': self.situacao.idsituacaoacao\n        }\n        response = self.client.post('/api/v1/acoes_pngi/acoes/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    def test_operador_can_update_acao(self):\n        \"\"\"OPERADOR_ACAO pode atualizar ação\"\"\"\n        self.authenticate_as('operador')\n        data = {'strdescricaoacao': 'Atualizado pelo Operador'}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/acoes/{self.acao.idacao}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_operador_can_delete_acao(self):\n        \"\"\"OPERADOR_ACAO pode deletar ação\"\"\"\n        acao_temp = Acoes.objects.create(\n            strapelido='ACAO-DEL-OPER',\n            strdescricaoacao='Para Deletar',\n            strdescricaoentrega='Entrega Del',\n            idvigenciapngi=self.vigencia,\n            ideixo=self.eixo,              # Adicionar para consistência\n            idsituacaoacao=self.situacao\n        )\n        \n        self.authenticate_as('operador')\n        response = self.client.delete(f'/api/v1/acoes_pngi/acoes/{acao_temp.idacao}/')\n        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)\n    \n    # ------------------------------------------------------------------------\n    # CONSULTOR_PNGI - Apenas Leitura\n    # ------------------------------------------------------------------------\n    \n    def test_consultor_can_list_acoes(self):\n        \"\"\"CONSULTOR_PNGI pode listar ações\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/acoes/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_consultor_can_retrieve_acao(self):\n        \"\"\"CONSULTOR_PNGI pode buscar ação específica\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get(f'/api/v1/acoes_pngi/acoes/{self.acao.idacao}/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_consultor_cannot_create_acao(self):\n        \"\"\"CONSULTOR_PNGI NÃO pode criar ação\"\"\"\n        self.authenticate_as('consultor')\n        data = {\n            'strapelido': 'ACAO-CONS',\n            'strdescricaoacao': 'Tentativa Consultor',\n            'strdescricaoentrega': 'Entrega Consultor',\n            'idvigenciapngi': self.vigencia.idvigenciapngi,\n            'ideixo': self.eixo.ideixo,\n            'idsituacaoacao': self.situacao.idsituacaoacao\n        }\n        response = self.client.post('/api/v1/acoes_pngi/acoes/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    def test_consultor_cannot_update_acao(self):\n        \"\"\"CONSULTOR_PNGI NÃO pode atualizar ação\"\"\"\n        self.authenticate_as('consultor')\n        data = {'strdescricaoacao': 'Update Consultor'}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/acoes/{self.acao.idacao}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    def test_consultor_cannot_delete_acao(self):\n        \"\"\"CONSULTOR_PNGI NÃO pode deletar ação\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.delete(f'/api/v1/acoes_pngi/acoes/{self.acao.idacao}/')\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    # ------------------------------------------------------------------------\n    # Testes de Relacionamentos\n    # ------------------------------------------------------------------------\n    \n    def test_acao_requires_vigencia(self):\n        \"\"\"Ação requer vigência (ForeignKey OBRIGATÓRIO)\"\"\"\n        self.authenticate_as('coordenador')\n        data = {\n            'strapelido': 'ACAO-SEM-VIG',\n            'strdescricaoacao': 'Sem Vigência',\n            'strdescricaoentrega': 'Sem Vigência'\n            # Sem idvigenciapngi - DEVE FALHAR\n        }\n        response = self.client.post('/api/v1/acoes_pngi/acoes/', data, format='json')\n        # Deve retornar erro de validação\n        self.assertIn(response.status_code, [\n            status.HTTP_400_BAD_REQUEST,  # Validação do serializer\n        ])\n    \n    def test_acao_with_filters(self):\n        \"\"\"Testar filtros de ação (por vigência, search, etc)\"\"\"\n        self.authenticate_as('consultor')\n        \n        # Filtro por vigência\n        response = self.client.get(\n            f'/api/v1/acoes_pngi/acoes/?idvigenciapngi={self.vigencia.idvigenciapngi}'\n        )\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n        \n        # Search\n        response = self.client.get('/api/v1/acoes_pngi/acoes/?search=ACAO-001')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n\n# ============================================================================\n# TESTES DE PRAZO - ViewSet: AcaoPrazoViewSet\n# ============================================================================\n\nclass AcaoPrazoAPITests(BaseAPITestCase):\n    \"\"\"\n    Testes de API para AcaoPrazo.\n    \n    Prazos são vinculados a ações.\n    Mesmas permissões que Acoes: COORDENADOR, GESTOR, OPERADOR podem gerenciar.\n    \n    Testa:\n    - Relacionamento obrigatório: idacao (ForeignKey)\n    - Constraint unique (idacao, strprazo)\n    - Flag isacaoprazoativo\n    - Custom action: ativos/\n    \n    Endpoints testados:\n    - GET    /api/v1/acoes_pngi/prazos/\n    - POST   /api/v1/acoes_pngi/prazos/\n    - GET    /api/v1/acoes_pngi/prazos/{id}/\n    - PATCH  /api/v1/acoes_pngi/prazos/{id}/\n    - DELETE /api/v1/acoes_pngi/prazos/{id}/\n    - GET    /api/v1/acoes_pngi/prazos/ativos/\n    \"\"\"\n    \n    def setup_test_data(self):\n        \"\"\"Cria TODOS relacionamentos necessários - simula ambiente real\"\"\"\n        # Chamar setup da classe base para criar Eixo e SituacaoAcao\n        super().setup_test_data()\n        \n        # Criar Vigência (necessária para Acao)\n        self.vigencia, _ = VigenciaPNGI.objects.get_or_create(\n            strdescricaovigenciapngi='PNGI 2026',\n            defaults={\n                'datiniciovigencia': date(2026, 1, 1),\n                'datfinalvigencia': date(2026, 12, 31)\n            }\n        )\n        \n        # Criar Acao COMPLETA (AcaoPrazo.idacao é obrigatório)\n        self.acao = Acoes.objects.create(\n            strapelido='ACAO-001',\n            strdescricaoacao='Ação Teste',\n            strdescricaoentrega='Entrega Teste',\n            idvigenciapngi=self.vigencia,\n            ideixo=self.eixo,\n            idsituacaoacao=self.situacao\n        )\n        \n        # Criar Prazo vinculado à Acao\n        self.prazo = AcaoPrazo.objects.create(\n            idacao=self.acao,\n            strprazo='2026-06-30',\n            isacaoprazoativo=True\n        )\n    \n    # ------------------------------------------------------------------------\n    # COORDENADOR_PNGI\n    # ------------------------------------------------------------------------\n    \n    def test_coordenador_can_list_prazos(self):\n        \"\"\"COORDENADOR_PNGI pode listar prazos\"\"\"\n        self.authenticate_as('coordenador')\n        response = self.client.get('/api/v1/acoes_pngi/prazos/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_coordenador_can_create_prazo(self):\n        \"\"\"COORDENADOR_PNGI pode criar prazo\"\"\"\n        self.authenticate_as('coordenador')\n        data = {\n            'idacao': self.acao.idacao,\n            'strprazo': '2026-09-30',\n            'isacaoprazoativo': True\n        }\n        response = self.client.post('/api/v1/acoes_pngi/prazos/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    def test_coordenador_can_update_prazo(self):\n        \"\"\"COORDENADOR_PNGI pode atualizar prazo\"\"\"\n        self.authenticate_as('coordenador')\n        data = {'isacaoprazoativo': False}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/prazos/{self.prazo.idacaoprazo}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_coordenador_can_delete_prazo(self):\n        \"\"\"COORDENADOR_PNGI pode deletar prazo\"\"\"\n        prazo_temp = AcaoPrazo.objects.create(\n            idacao=self.acao,\n            strprazo='2026-12-31',\n            isacaoprazoativo=False\n        )\n        \n        self.authenticate_as('coordenador')\n        response = self.client.delete(f'/api/v1/acoes_pngi/prazos/{prazo_temp.idacaoprazo}/')\n        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)\n    \n    # ------------------------------------------------------------------------\n    # OPERADOR_ACAO - Pode Gerenciar\n    # ------------------------------------------------------------------------\n    \n    def test_operador_can_manage_prazos(self):\n        \"\"\"OPERADOR_ACAO pode gerenciar prazos\"\"\"\n        self.authenticate_as('operador')\n        \n        # LIST\n        response = self.client.get('/api/v1/acoes_pngi/prazos/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n        \n        # CREATE\n        data = {\n            'idacao': self.acao.idacao,\n            'strprazo': '2026-10-15',\n            'isacaoprazoativo': True\n        }\n        response = self.client.post('/api/v1/acoes_pngi/prazos/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    # ------------------------------------------------------------------------\n    # CONSULTOR_PNGI - Apenas Leitura\n    # ------------------------------------------------------------------------\n    \n    def test_consultor_can_list_prazos(self):\n        \"\"\"CONSULTOR_PNGI pode listar prazos\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/prazos/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_consultor_cannot_create_prazo(self):\n        \"\"\"CONSULTOR_PNGI NÃO pode criar prazo\"\"\"\n        self.authenticate_as('consultor')\n        data = {\n            'idacao': self.acao.idacao,\n            'strprazo': '2026-11-30',\n            'isacaoprazoativo': True\n        }\n        response = self.client.post('/api/v1/acoes_pngi/prazos/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    # ------------------------------------------------------------------------\n    # Testes de Custom Actions e Filtros\n    # ------------------------------------------------------------------------\n    \n    def test_list_only_active_prazos(self):\n        \"\"\"Custom action: listar apenas prazos ativos\"\"\"\n        # Criar prazo inativo\n        AcaoPrazo.objects.create(\n            idacao=self.acao,\n            strprazo='2026-03-31',\n            isacaoprazoativo=False\n        )\n        \n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/prazos/ativos/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        # Custom action retorna lista direta, não paginada\n        self.assertIsInstance(response.data, list)\n        self.assertGreater(len(response.data), 0)\n    \n    def test_filter_prazos_by_acao(self):\n        \"\"\"Filtrar prazos por ação\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get(f'/api/v1/acoes_pngi/prazos/?idacao={self.acao.idacao}')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_filter_prazos_by_isativo(self):\n        \"\"\"Filtrar prazos por status ativo\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/prazos/?isacaoprazoativo=true')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n\n# ============================================================================\n# TESTES DE DESTAQUE - ViewSet: AcaoDestaqueViewSet\n# ============================================================================\n\nclass AcaoDestaqueAPITests(BaseAPITestCase):\n    \"\"\"\n    Testes de API para AcaoDestaque.\n    \n    Destaques são vinculados a ações.\n    Mesmas permissões que Acoes: COORDENADOR, GESTOR, OPERADOR podem gerenciar.\n    \n    Testa:\n    - Relacionamento obrigatório: idacao (ForeignKey)\n    - Constraint unique (idacao, ordenacao)\n    - Campo ordenacao\n    \n    Endpoints testados:\n    - GET    /api/v1/acoes_pngi/destaques/\n    - POST   /api/v1/acoes_pngi/destaques/\n    - GET    /api/v1/acoes_pngi/destaques/{id}/\n    - PATCH  /api/v1/acoes_pngi/destaques/{id}/\n    - DELETE /api/v1/acoes_pngi/destaques/{id}/\n    \"\"\"\n    \n    def setup_test_data(self):\n        \"\"\"Cria TODOS relacionamentos necessários - simula ambiente real\"\"\"\n        # Chamar setup da classe base para criar Eixo e SituacaoAcao\n        super().setup_test_data()\n        \n        # Criar Vigência (necessária para Acao)\n        self.vigencia, _ = VigenciaPNGI.objects.get_or_create(\n            strdescricaovigenciapngi='PNGI 2026',\n            defaults={\n                'datiniciovigencia': date(2026, 1, 1),\n                'datfinalvigencia': date(2026, 12, 31)\n            }\n        )\n        \n        # Criar Acao COMPLETA (AcaoDestaque.idacao é obrigatório)\n        self.acao = Acoes.objects.create(\n            strapelido='ACAO-001',\n            strdescricaoacao='Ação Teste',\n            strdescricaoentrega='Entrega Teste',\n            idvigenciapngi=self.vigencia,\n            ideixo=self.eixo,\n            idsituacaoacao=self.situacao\n        )\n        \n        # Criar Destaque vinculado à Acao\n        self.destaque = AcaoDestaque.objects.create(\n            idacao=self.acao,\n            datdatadestaque=timezone.now()\n        )\n    \n    # ------------------------------------------------------------------------\n    # COORDENADOR_PNGI\n    # ------------------------------------------------------------------------\n    \n    def test_coordenador_can_list_destaques(self):\n        \"\"\"COORDENADOR_PNGI pode listar destaques\"\"\"\n        self.authenticate_as('coordenador')\n        response = self.client.get('/api/v1/acoes_pngi/destaques/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_coordenador_can_create_destaque(self):\n        \"\"\"COORDENADOR_PNGI pode criar destaque\"\"\"\n        self.authenticate_as('coordenador')\n        data = {\n            'idacao': self.acao.idacao,\n            'datdatadestaque': timezone.now().isoformat()\n        }\n        response = self.client.post('/api/v1/acoes_pngi/destaques/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    def test_coordenador_can_update_destaque(self):\n        \"\"\"COORDENADOR_PNGI pode atualizar destaque\"\"\"\n        self.authenticate_as('coordenador')\n        data = {'datdatadestaque': timezone.now().isoformat()}\n        response = self.client.patch(\n            f'/api/v1/acoes_pngi/destaques/{self.destaque.idacaodestaque}/',\n            data,\n            format='json'\n        )\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n    \n    def test_coordenador_can_delete_destaque(self):\n        \"\"\"COORDENADOR_PNGI pode deletar destaque\"\"\"\n        destaque_temp = AcaoDestaque.objects.create(\n            idacao=self.acao,\n            datdatadestaque=timezone.now()\n        )\n        \n        self.authenticate_as('coordenador')\n        response = self.client.delete(\n            f'/api/v1/acoes_pngi/destaques/{destaque_temp.idacaodestaque}/'\n        )\n        self.assertEqual(response.status_code, status.HTTP_204_NO_CONTENT)\n    \n    # ------------------------------------------------------------------------\n    # OPERADOR_ACAO - Pode Gerenciar\n    # ------------------------------------------------------------------------\n    \n    def test_operador_can_manage_destaques(self):\n        \"\"\"OPERADOR_ACAO pode gerenciar destaques\"\"\"\n        self.authenticate_as('operador')\n        \n        # LIST\n        response = self.client.get('/api/v1/acoes_pngi/destaques/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n        \n        # CREATE\n        data = {\n            'idacao': self.acao.idacao,\n            'datdatadestaque': timezone.now().isoformat()\n        }\n        response = self.client.post('/api/v1/acoes_pngi/destaques/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_201_CREATED)\n    \n    # ------------------------------------------------------------------------\n    # CONSULTOR_PNGI - Apenas Leitura\n    # ------------------------------------------------------------------------\n    \n    def test_consultor_can_list_destaques(self):\n        \"\"\"CONSULTOR_PNGI pode listar destaques\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/destaques/')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_consultor_cannot_create_destaque(self):\n        \"\"\"CONSULTOR_PNGI NÃO pode criar destaque\"\"\"\n        self.authenticate_as('consultor')\n        data = {\n            'idacao': self.acao.idacao,\n            'datdatadestaque': timezone.now().isoformat()\n        }\n        response = self.client.post('/api/v1/acoes_pngi/destaques/', data, format='json')\n        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)\n    \n    # ------------------------------------------------------------------------\n    # Testes de Filtros e Ordenação\n    # ------------------------------------------------------------------------\n    \n    def test_filter_destaques_by_acao(self):\n        \"\"\"Filtrar destaques por ação\"\"\"\n        self.authenticate_as('consultor')\n        response = self.client.get(f'/api/v1/acoes_pngi/destaques/?idacao={self.acao.idacao}')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n    \n    def test_destaques_ordered_by_ordenacao(self):\n        \"\"\"Destaques devem vir ordenados por campo ordenacao\"\"\"\n        # Criar mais destaques com diferentes ordenações\n        AcaoDestaque.objects.create(\n            idacao=self.acao,\n            datdatadestaque=timezone.now()\n        )\n        AcaoDestaque.objects.create(\n            idacao=self.acao,\n            datdatadestaque=timezone.now()\n        )\n        \n        self.authenticate_as('consultor')\n        response = self.client.get('/api/v1/acoes_pngi/destaques/?ordering=-datdatadestaque')\n        self.assertEqual(response.status_code, status.HTTP_200_OK)\n        self.assertGreater(len(response.data['results']), 0)\n

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redefinir Senha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
    }
    .reset-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 2rem;
      max-width: 400px;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
    }
    .btn-primary:hover {
      background: linear-gradient(45deg, #5a67d8, #6b46c1);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-md-6">
        <div class="reset-container">
          <h2 class="text-center mb-4">Esqueci minha senha</h2>
          
          <div id="requestForm">
            <form id="resetRequestForm">
              <div class="mb-3">
                <label for="email" class="form-label">Email:</label>
                <input type="email" class="form-control" id="email" required>
              </div>
              
              <button type="submit" class="btn btn-primary w-100 mb-3">Enviar link de redefinição de senha</button>
            </form>
          </div>
          
          <div class="text-center">
            <a href="#" id="linkBackToLogin" class="text-decoration-none">Voltar ao Login</a>
          </div>
          
          <div id="message" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    
      let currentEmail = null;
      let siteURL = '';
      
      const emailInput = document.getElementById('email');
      emailInput.disabled = true;
      const messageDiv = document.getElementById('message');
      const submitButton = document.querySelector('#resetRequestForm button[type="submit"]');
      submitButton.disabled = true;

      // Função para redirecionar para o login (chamada por um clique)
      function redirectToLogin() {
        messageDiv.innerHTML = '<div class="alert alert-info">Redirecionando...</div>';
        if (siteURL) {
          window.location.href = siteURL + '?page=login'; // Garante que vá para o login
        } else {
          // Fallback, caso a URL não seja obtida
          window.top.location.reload();
        }
      }

      document.addEventListener('DOMContentLoaded', function () {

        // Busca a URL do site para usar nos redirecionamentos
        google.script.run
          .withSuccessHandler(function (result) {
            if (result && result.siteURL) {
              siteURL = result.siteURL;
              // Configura o link de "Voltar" estático
              document.getElementById('linkBackToLogin').addEventListener('click', function (e) {
                e.preventDefault();
                redirectToLogin();
              });
            }
          })
          .getSiteProperty();

        // Recupera o e-mail que foi salvo na etapa anterior
        google.script.run
          .withSuccessHandler(function (result) {
            if (result && result.email) {
              currentEmail = result.email;
              //const emailInput = document.getElementById('email');
              if (emailInput) {
                emailInput.disabled = false;
                emailInput.value = currentEmail;
                emailInput.disabled = true;
                submitButton.disabled = false;
              }
            } else {
              messageDiv.innerHTML = '<div class="alert alert-warning">Não foi possível recuperar o e-mail. Por favor, volte e tente novamente.</div>';
            }
          })
          .getEmailProperty();
      });

      // Listener para o formulário de envio
      document.getElementById('resetRequestForm').addEventListener('submit', function (e) {
        e.preventDefault();
        
        if (!currentEmail) {
          messageDiv.innerHTML = '<div class="alert alert-warning">E-mail não encontrado. Por favor, volte e tente novamente.</div>';
          return;
        }

        submitButton.disabled = true;
        document.getElementById('linkBackToLogin').style.display = 'none'; // Esconde o link antigo

        messageDiv.innerHTML = '<div class="alert alert-info">Enviando link de redefinição...</div>';

        google.script.run
          .withSuccessHandler(function (result) {
            // Remove o botão de submit original
            submitButton.style.display = 'none';

            if (result.success) {
              // *** INÍCIO DA MUDANÇA PRINCIPAL ***
              // Exibe a mensagem de sucesso e um NOVO botão para voltar
              messageDiv.innerHTML = `
                <div class="alert alert-success">${result.message}</div>
                <button id="manualRedirectButton" class="btn btn-primary w-100">Voltar ao Login</button>
              `;
              // *** FIM DA MUDANÇA PRINCIPAL ***
              // Adiciona o evento de clique ao novo botão
              document.getElementById('manualRedirectButton').addEventListener('click', redirectToLogin);
            } else {
              messageDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
              submitButton.disabled = false; // Reabilita se deu erro
              document.getElementById('linkBackToLogin').style.display = 'block'; // Mostra o link de novo
            }
          })
          .withFailureHandler(function (error) {
            messageDiv.innerHTML = `<div class="alert alert-danger">Erro de conexão: ${error.message}</div>`;
            submitButton.disabled = false;
            document.getElementById('linkBackToLogin').style.display = 'block';
          })
          .sendResetLink(currentEmail);
      });
  </script>


</body>
</html>